# AgentSocial - 功能需求文档 (FRD)

**版本**: 1.0.0
**日期**: 2026-02-07
**项目状态**: 核心功能已实现 (Alpha)

---

## 1. 引言 (Introduction)

### 1.1 项目背景
AgentSocial 旨在为本地运行的 AI 编程 Agent（如 Google Gemini CLI, Claude Code）提供一个“社交身份”。通过充当中间件，它允许用户通过飞书（Lark）等社交协作平台，远程、安全、交互式地控制本地开发环境中的 Agent 执行编程任务。

### 1.2 核心目标
*   **连接性**: 打通即时通讯软件与本地 CLI 工具的壁垒。
*   **安全性**: 引入“计划-审批-执行”的双阶段机制，防止 AI 幻觉导致破坏性操作。
*   **隔离性**: 确保不同会话（群组/私聊）之间的上下文和历史记录互不干扰。

---

## 2. 用户角色 (User Personas)

*   **开发者 (End User)**: 通过飞书客户端发送指令，审核代码变更计划，接收执行结果。
*   **运维/部署者 (Host Admin)**: 在本地机器或私有服务器上配置 Node.js 环境、安装 Agent CLI 并运行 AgentSocial 服务。

---

## 3. 功能性需求 (Functional Requirements)

### 3.1 命令行接口与配置 (CLI & Configuration)

#### FR-01: 环境自检与依赖管理
*   **系统应能自动检测**当前环境是否安装了支持的 Agent CLI（目前支持：Gemini CLI；预留：Claude, Codex）。
*   **依赖检查**: 启动时若缺少关键依赖（如 Node.js 版本过低），应报错并终止。

#### FR-02: 交互式配置向导 (`setup`)
*   **输入**: 用户运行 `agent-social setup`。
*   **流程**:
    1.  **欢迎界面**: 展示品牌 Banner 及项目简介。
    2.  **AI 核心选择**: 选择目标 Agent 引擎（当前固定为 Gemini CLI，其他置灰）。
    3.  **凭证输入**: 输入飞书 App ID、App Secret 及项目路径。
    4.  **配置指引**: 逐步引导用户在飞书后台完成 Scopes 和事件配置。
    5.  **实时诊断**: 调用 API 进行 4 项核心能力自检。
*   **输出**: 生成或更新 `config.json` 文件。

#### FR-03: 飞书能力自动诊断
*   在配置阶段，系统必须调用飞书 API 验证以下状态：
    *   **Bot 能力**: 检查机器人功能是否在后台启用。
    *   **消息权限**: 验证 `im:message:readonly`。
    *   **群组权限**: 验证 `im:chat:readonly`。
    *   **应用信息权限**: 验证 `admin:app.info:readonly`。
*   **反馈**: 输出对齐美观的诊断表格，包含具体的 Error 和 Hint 分层指引。

### 3.2 社交平台交互 (Social Interaction - Feishu)

#### FR-04: 消息接收与指令解析
*   **连接方式**: 使用 WebSocket 长连接模式，无需公网 IP 或 Webhook 配置。
*   **触发方式**:
    *   **单聊 (P2P)**: 直接发送文本指令。
    *   **群聊 (Group)**: 通过 `@机器人` + 文本指令触发。
*   **多端同步**: 所有交互卡片必须配置 `update_multi: true`，确保 PC 端与移动端状态实时一致。

#### FR-05: 智能卡片交互系统
*   **状态反馈**: 接收指令后，立即回复“正在思考/生成计划”状态。
*   **计划卡片 (Plan Card)**:
    *   展示用户原始指令。
    *   **折叠面板**: 将 AI 生成的长篇执行计划包裹在折叠区域，避免刷屏。
    *   **操作按钮**: 提供“🚀 确认执行”和“✖ 拒绝/取消”按钮。
*   **结果卡片 (Result Card)**:
    *   **成功状态**: 默认收起输出详情，显示绿色标题。
    *   **失败状态**: 默认展开输出详情，显示红色标题，方便快速定位错误。

#### FR-06: 交互响应性能优化
*   **极速响应**: 用户点击卡片按钮时，系统必须在 **3秒内** 返回 `Toast` 提示（如“操作已确认”），防止飞书客户端报错。
*   **异步更新**: 实际的卡片 UI 刷新（如将按钮变为“执行中”）通过异步 API 调用完成。

### 3.3 Agent 核心执行引擎 (Agent Core Execution)

#### FR-07: 双阶段执行逻辑
*   **阶段一 (Plan Mode)**:
    *   调用 Agent CLI 生成纯文本计划。
    *   禁止实际写入文件或执行 Shell 命令。
*   **阶段二 (Auto Mode)**:
    *   仅在用户点击“确认”后触发。
    *   调用 Agent CLI 实际执行任务。
    *   **路径上下文**: 必须将当前工作目录 (`cwd`) 锁定为 **项目根目录**，以确保文件操作正确。

#### FR-08: 会话与环境隔离
*   **隔离策略**: 系统为每个 `AppID + ChatID` 组合创建一个唯一的 `Session Workspace`。
*   **存储路径**: `sessions/{app_id}/{chat_id}/`。
*   **内容**: 包含该会话独立的 `.gemini` 历史记录、配置副本和临时文件。
*   **目的**: 防止群聊 A 的上下文污染群聊 B 的任务。

#### FR-09: 智能预热 (Pre-warming)
*   **触发**: 服务启动时。
*   **动作**: 自动对配置的项目执行一次轻量级“列出文件”或“建立索引”任务。
*   **目的**: 消除首次交互时的模型冷启动延迟。

### 3.4 敏感操作风控 (Risk Control)

#### FR-10: 敏感操作拦截
*   当 Agent 尝试执行高风险操作（逻辑由 Agent CLI 定义，如删除文件、推送代码）时，必须中断并回调。
*   **审批卡片**: 推送包含具体风险指令的卡片，需人工二次点击“批准”方可放行。

#### FR-11: 基于应用可见范围的访问控制
*   **授权检测**: 机器人启动时应自动通过 `/visibility` 接口加载“应用可见范围”成员。
*   **指令拦截**: 只有白名单内的成员（或开启全员可见时）才被允许下达指令。
*   **越权反馈**: 针对非授权成员，机器人应返回明确的访问受限提示，告知如何获取授权。

#### FR-12: 上线下线广播通知
*   **全渠道通知**: 机器人启动成功或服务停止前，应向已加入的所有群组发送状态卡片。
*   **P2P 直达**: 向“应用可见范围”内的每位授权成员发送个人私聊卡片，增强服务透明度。
*   **防骚扰**: 若可见范围为“全员”，自动跳过 P2P 广播以避免大规模信息干扰。

---

## 4. 非功能性需求 (Non-Functional Requirements)

### 4.1 性能 (Performance)
*   **API 响应**: 卡片点击交互的同步响应时间 < 1000ms。
*   **并发处理**: 支持基本的任务队列，防止对 Gemini API 发起过高的并发请求导致 429 错误。

### 4.2 安全性 (Security)
*   **数据驻留**: 代码和执行逻辑完全在本地运行，不上传至 AgentSocial 的任何云端服务器（仅依赖 Agent CLI 自身的模型交互）。
*   **凭证安全**: `config.json` 存储本地，不通过网络传输。

### 4.3 兼容性 (Compatibility)
*   **操作系统**: Windows, macOS, Linux。
*   **Node.js**: v18.0.0+。
*   **客户端**: 兼容飞书 PC 端、移动端（iOS/Android）及网页版。

---

## 5. 待开发规划 (Future Roadmap)

*   [ ] **Docker 镜像支持**: 提供标准 Dockerfile，实现一键沙箱部署。
*   [ ] **多 Agent 混合调度**: 支持在一个任务中同时调用 Gemini 规划和 Claude 审查代码。
*   [ ] **Web 管理后台**: 提供图形化的 Web 界面来管理 `config.json` 和查看历史日志。
